[
  {
    "id": "advilmax",
    "nombre": "Advil Max",
    "precio": "$20.000 - sobre x 10",
    "imagen": "img/advilmax.jpeg",
    "descripcion": "Alivio rÃ¡pido del dolor de cabeza, fiebre y malestar general."
  },
  {
    "id": "bonfiest",
    "nombre": "Bonfiest",
    "precio": "$3.297 unidad",
    "imagen": "img/bonfiest.png",
    "descripcion": "Tabletas efervescentes para aliviar la acidez y malestar estomacal."
  }
]


// ============================
// CONFIGURACIÃ“N GLOBAL
// ============================
const contenedorProveedores = document.getElementById("listaProveedores");
const contenedorProductos = document.getElementById("productos");
const contenedorCarrusel = document.getElementById("carrusel");
const modalAuth = document.getElementById("authModal");
const formRegistro = document.getElementById("formRegistro");
const formLogin = document.getElementById("formLogin");
const mensajeBienvenida = document.getElementById("mensajeBienvenida");
const paginacion = document.querySelector(".paginacion");

let productos = [];
let paginaActual = 1;
const productosPorPagina = 12;
let usuarioActual = null;
let proveedorActual = null;

// ============================
// UTIL: PAUSAR / RESTAURAR VIDEOS (AGRESIVO Y ROBUSTO)
// ============================
// Guarda la fuente original en data-orig-src y quita el src para detener el stream.
// Si resetTime true, tambiÃ©n reinicia currentTime a 0.
function aggressivePauseAllMedia({ resetTime = true, mute = true } = {}) {
  document.querySelectorAll("video, audio").forEach((m) => {
    try {
      // guardar src original para poder restaurar luego
      if (m.src) {
        m.dataset._origSrc = m.src;
        // quitar la fuente para detener totalmente la reproducciÃ³n
        m.removeAttribute("src");
      }
      // pausar y resetear tiempo
      m.pause();
      if (resetTime) m.currentTime = 0;
      // asegurar que no emita sonido
      if (mute) m.muted = true;
      // forzar que el navegador recargue/limpie
      m.load();
    } catch (err) {
      console.warn("aggressivePauseAllMedia error:", err);
    }
  });

  // emitir evento global para que otros scripts (videos.js) limpien timers
  window.dispatchEvent(new Event("app:videos-paused"));
}

// Restaura src guardados y reintenta reproducir (desmute opcional)
async function restoreAllMedia({ unmute = false, tryPlay = true } = {}) {
  document.querySelectorAll("video, audio").forEach(async (m) => {
    try {
      // si guardamos el origen, restÃ¡uralo
      if (m.dataset && m.dataset._origSrc) {
        m.src = m.dataset._origSrc;
        delete m.dataset._origSrc;
      }
      m.load();
      if (unmute) m.muted = false;
      if (tryPlay) {
        try {
          await m.play();
        } catch (e) {
          // autoplay bloqueado por navegador: quedarÃ¡ pausado hasta interacciÃ³n
        }
      }
    } catch (err) {
      console.warn("restoreAllMedia error:", err);
    }
  });

  window.dispatchEvent(new Event("app:videos-resume"));
}

// ============================
// BASE LOCAL DE CLIENTES
// ============================
function guardarClienteBase(usuario) {
  let base = JSON.parse(localStorage.getItem("baseClientes")) || [];
  const existe = base.some(c => c.cedula === usuario.cedula);

  if (!existe) {
    base.push(usuario);
    localStorage.setItem("baseClientes", JSON.stringify(base));
    console.log("ðŸŸ¢ Cliente guardado:", usuario);
  }
}

function verBaseClientes() {
  return JSON.parse(localStorage.getItem("baseClientes")) || [];
}

// ============================
// CARGAR PROVEEDORES
// ============================
async function cargarProveedores() {
  try {
    const res = await fetch("data/proveedores.json");
    const proveedores = await res.json();

    if (!contenedorProveedores) {
      console.error("contenedorProveedores no encontrado en el DOM.");
      return;
    }

    contenedorProveedores.innerHTML = proveedores.map(p => `
      <div class="card-proveedor" onclick="abrirProveedor('${p.id}', '${p.nombre}')">
        <img src="${p.logo}" alt="${p.nombre}">
        <h3>${p.nombre}</h3>
      </div>
    `).join('');

    proveedorActual = null;
    ocultarPaginacion();

    // Asegurarnos de que al cargar la vista principal restauramos media
    restoreAllMedia({ unmute: false, tryPlay: true });

  } catch (error) {
    if (contenedorProveedores) contenedorProveedores.innerHTML = "<p>Error al cargar los proveedores.</p>";
    console.error("Error al cargar proveedores:", error);
  }
}

// ============================
// ABRIR CATÃLOGO DE PROVEEDOR
// ============================
async function abrirProveedor(id, nombre) {
  try {
    // 1) Pausar/limpiar cualquier media activa (forma agresiva)
    aggressivePauseAllMedia({ resetTime: true, mute: true });

    // 2) Cargar productos del JSON correspondiente (productos_proveedor_X.json)
    const res = await fetch(`data/productos_proveedor_${id}.json`);
    productos = await res.json();

    paginaActual = 1;
    proveedorActual = { id, nombre };

    // 3) Traer datos extra del proveedor para header (logo/banner)
    let proveedorData = null;
    try {
      const provRes = await fetch("data/proveedores.json");
      const provs = await provRes.json();
      proveedorData = provs.find(p => String(p.id) === String(id)) || null;
    } catch (err) {
      console.warn("No se pudo cargar datos adicionales del proveedor:", err);
    }

    // 4) Render header catÃ¡logo con logo y buscador (solo para este proveedor)
    const tituloEl = document.getElementById("tituloCatalogo");
    if (tituloEl) {
      const logoHtml = proveedorData && proveedorData.logo ? `<img src="${proveedorData.logo}" alt="${nombre}" class="catalogo-logo" />` : "";
      const bannerHtml = proveedorData && proveedorData.banner ? `<div class="catalogo-banner"><img src="${proveedorData.banner}" alt="Banner ${nombre}" /></div>` : "";
      tituloEl.innerHTML = `
        <div class="header-catalogo">
          <button class="btn-volver" onclick="volverAProveedores()">â¬… Volver a proveedores</button>
          ${logoHtml}
          <div>
            <h2>CatÃ¡logo de Distribuidora ${nombre}</h2>
            <div class="buscador-catalogo"><input id="buscarCatalogo" placeholder="Buscar en el catÃ¡logo de ${nombre}..." /></div>
          </div>
        </div>
        ${bannerHtml}
      `;

      // Conectar buscador para filtrar solo este catÃ¡logo
      const inputBuscar = document.getElementById("buscarCatalogo");
      if (inputBuscar) {
        inputBuscar.addEventListener("input", (e) => {
          filtrarCatalogo(e.target.value);
        });
      }
    }

    // 5) Ocultar secciones principales (videos, ofertas, lista de proveedores)
    const seccionVideos = document.querySelector(".video-stories") || document.querySelector(".videos");
    const seccionOfertas = document.querySelector(".ofertas");
    const seccionProveedores = document.querySelector(".proveedores") || contenedorProveedores;
    const seccionCatalogo = document.querySelector(".catalogo");

    if (seccionVideos) seccionVideos.style.display = "none";
    if (seccionOfertas) seccionOfertas.style.display = "none";
    if (seccionProveedores) seccionProveedores.style.display = "none";
    if (seccionCatalogo) seccionCatalogo.style.display = "block";

    // 6) Mostrar productos del proveedor
    mostrarProductos();
    mostrarPaginacion();

    // Scroll suave al catÃ¡logo
    setTimeout(() => {
      document.querySelector(".catalogo")?.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 250);

  } catch (error) {
    if (contenedorProductos) contenedorProductos.innerHTML = "<p>Error al cargar productos del proveedor.</p>";
    console.error("Error cargando productos:", error);
  }
}
window.abrirProveedor = abrirProveedor;

// ============================
// VOLVER A PROVEEDORES
// ============================
function volverAProveedores() {
  contenedorProductos.innerHTML = "";
  const tituloEl = document.getElementById("tituloCatalogo");
  if (tituloEl) tituloEl.innerHTML = "ðŸª Revisa Aqui tu proveedor";
  proveedorActual = null;
  productos = [];

  // Mostrar secciones principales y ocultar catÃ¡logo
  const seccionVideos = document.querySelector(".video-stories") || document.querySelector(".videos");
  const seccionOfertas = document.querySelector(".ofertas");
  const seccionProveedores = document.querySelector(".proveedores") || contenedorProveedores;
  const seccionCatalogo = document.querySelector(".catalogo");

  if (seccionCatalogo) seccionCatalogo.style.display = "none";
  if (seccionVideos) seccionVideos.style.display = "";
  if (seccionOfertas) seccionOfertas.style.display = "";
  if (seccionProveedores) seccionProveedores.style.display = "";

  cargarProveedores();
  ocultarPaginacion();

  // Restaurar medios (reponer src y reintentar play si el navegador permite)
  setTimeout(() => {
    restoreAllMedia({ unmute: false, tryPlay: true });
  }, 300);

  setTimeout(() => {
    document.querySelector(".proveedores")?.scrollIntoView({ behavior: "smooth", block: "start" });
  }, 200);
}

// ============================
// FILTRAR CATALOGO (BUSCADOR LOCAL DEL PROVEEDOR)
// ============================
function filtrarCatalogo(texto) {
  if (!productos || !productos.length) return;
  const q = (texto || "").toLowerCase().trim();
  if (!q) {
    mostrarProductos(false);
    return;
  }
  const filtrados = productos.filter(p => {
    const combined = `${p.nombre || ""} ${p.descripcion || ""} ${p.codigo || ""}`.toLowerCase();
    return combined.includes(q);
  });

  const contenedor = document.getElementById("productos");
  if (!contenedor) return;
  contenedor.innerHTML = "";
  filtrados.forEach(prod => {
    const card = document.createElement("div");
    card.className = "card animar-entrada";
    card.innerHTML = `
      <img src="${prod.imagen}" alt="${prod.nombre}">
      <h3>${prod.nombre}</h3>
      <p>${prod.precio}</p>
      <a href="https://wa.me/573143416441?text=Hola, quiero comprar este producto: ${prod.nombre}%0AValor: ${prod.precio}%0A${window.location.origin}?producto=${encodeURIComponent(prod.nombre)}"
         target="_blank" class="btn-wsp">
        <i class="fab fa-whatsapp"></i> COMPRAR
      </a>
    `;
    contenedor.appendChild(card);
  });

  if (paginacion) paginacion.style.display = "none";
}

// ============================
// MOSTRAR PRODUCTOS CON PAGINACIÃ“N
// ============================
function mostrarProductos(animar = true) {
  if (!productos.length) {
    if (contenedorProductos) contenedorProductos.innerHTML = "<p>No hay productos disponibles.</p>";
    return;
  }

  const contenedor = document.getElementById("productos");
  if (!contenedor) return;

  if (animar) contenedor.classList.add("efecto-pagina");

  setTimeout(() => {
    contenedor.innerHTML = "";
    const inicio = (paginaActual - 1) * productosPorPagina;
    const fin = inicio + productosPorPagina;
    const productosPagina = productos.slice(inicio, fin);

    productosPagina.forEach(prod => {
      const card = document.createElement("div");
      card.className = "card animar-entrada";
      card.innerHTML = `
        <img src="${prod.imagen}" alt="${prod.nombre}">
        <h3>${prod.nombre}</h3>
        <p>${prod.precio}</p>
        <a href="https://wa.me/573143416441?text=Hola, quiero comprar este producto: ${prod.nombre}%0AValor: ${prod.precio}%0A${window.location.origin}?producto=${encodeURIComponent(prod.nombre)}"
           target="_blank" class="btn-wsp">
          <i class="fab fa-whatsapp"></i> COMPRAR
        </a>
      `;
      contenedor.appendChild(card);
    });

    const paginaActualEl = document.getElementById("paginaActual");
    if (paginaActualEl) paginaActualEl.textContent = `PÃ¡gina ${paginaActual}`;

    if (animar) setTimeout(() => contenedor.classList.remove("efecto-pagina"), 700);
  }, animar ? 200 : 0);
}

// ============================
// PAGINACIÃ“N
// ============================
function siguientePagina() {
  if (!proveedorActual) return;
  const totalPaginas = Math.ceil(productos.length / productosPorPagina);
  if (paginaActual < totalPaginas) {
    paginaActual++;
    mostrarProductos();
    document.querySelector(".catalogo")?.scrollIntoView({ behavior: "smooth", block: "start" });
  }
}

function anteriorPagina() {
  if (!proveedorActual) return;
  if (paginaActual > 1) {
    paginaActual--;
    mostrarProductos();
    document.querySelector(".catalogo")?.scrollIntoView({ behavior: "smooth", block: "start" });
  }
}

function mostrarPaginacion() {
  if (paginacion) paginacion.style.display = "flex";
}
function ocultarPaginacion() {
  if (paginacion) paginacion.style.display = "none";
}

// ============================
// COMPRAR PRODUCTO
// ============================
function comprarProducto(idProducto) {
  const producto = productos.find(p => p.id === idProducto);
  if (!producto) return;

  if (!usuarioActual) {
    abrirModalAuth(producto);
    return;
  }
  enviarWhatsApp(producto);
}

function enviarWhatsApp(producto) {
  const mensaje = `Hola ${usuarioActual?.nombre || ""}, quiero comprar este producto:%0A
*${producto.nombre}*%0A
${producto.descripcion || ""}%0A
Precio: ${producto.precio}%0A
${window.location.origin}?producto=${encodeURIComponent(producto.nombre)}`;
  const url = `https://wa.me/573143416441?text=${mensaje}`;
  window.open(url, "_blank");
}

// ============================
// LOGIN Y REGISTRO
// ============================
function abrirModalAuth(producto) {
  if (!modalAuth) return;
  modalAuth.style.display = "flex";
  modalAuth.dataset.producto = JSON.stringify(producto);
}

if (formRegistro) {
  formRegistro.addEventListener("submit", (e) => {
    e.preventDefault();
    const nuevoUsuario = {
      nombre: document.getElementById("nombre").value,
      apellido: document.getElementById("apellido").value,
      cedula: document.getElementById("cedula").value,
      telefono: document.getElementById("telefono").value,
      fechaRegistro: new Date().toLocaleString()
    };

    localStorage.setItem("usuario", JSON.stringify(nuevoUsuario));
    guardarClienteBase(nuevoUsuario);
    usuarioActual = nuevoUsuario;

    if (mensajeBienvenida) mensajeBienvenida.textContent = `Â¡Bienvenido me alegra mucho verte de nuevo , ${usuarioActual.nombre}! ðŸ‘‹`;
    if (modalAuth) modalAuth.style.display = "none";

    const productoPendiente = JSON.parse(modalAuth?.dataset.producto || "null");
    if (productoPendiente) enviarWhatsApp(productoPendiente);
  });
}

if (formLogin) {
  formLogin.addEventListener("submit", (e) => {
    e.preventDefault();
    const cedulaLogin = document.getElementById("cedulaLogin").value;
    const base = JSON.parse(localStorage.getItem("baseClientes")) || [];
    const usuarioGuardado = base.find(u => u.cedula === cedulaLogin);

    if (usuarioGuardado) {
      usuarioActual = usuarioGuardado;
      localStorage.setItem("usuario", JSON.stringify(usuarioActual));
      if (mensajeBienvenida) mensajeBienvenida.textContent = `Â¡Hola de nuevo, ${usuarioActual.nombre}! ðŸ‘‹`;
      if (modalAuth) modalAuth.style.display = "none";

      const productoPendiente = JSON.parse(modalAuth?.dataset.producto || "null");
      if (productoPendiente) enviarWhatsApp(productoPendiente);
    } else {
      alert("CÃ©dula no registrada. RegÃ­strate primero.");
    }
  });
}

// ============================
// CARRUSEL DE OFERTAS
// ============================
async function cargarOfertas() {
  try {
    const res = await fetch("data/ofertas.json");
    const productosOfertas = await res.json();

    if (!contenedorCarrusel) {
      console.warn("contenedorCarrusel no encontrado");
      return;
    }

    contenedorCarrusel.innerHTML = productosOfertas.map(p => `
      <div class="item" onclick="enviarWhatsAppCarrusel(${p.id})">
        <div class="cinta">${p.badge || "Oferta"}</div>
        <img src="${p.imagen}" alt="${p.nombre}" title="${p.nombre}">
        <div class="info-oferta">
          <h4>${p.nombre}</h4>
          <p>${p.precio}</p>
          <p>${p.descripcion}</p>
        
        </div>
      </div>
    `).join('');

    let position = 0;
    const velocidad = 0.5;
    setInterval(() => {
      position += velocidad;
      contenedorCarrusel.scrollLeft = position;
      if (position >= contenedorCarrusel.scrollWidth - contenedorCarrusel.clientWidth) position = 0;
    }, 20);
  } catch (err) {
    console.error("Error cargando ofertas:", err);
  }
}

function enviarWhatsAppCarrusel(idProducto) {
  fetch("data/ofertas.json")
    .then(res => res.json())
    .then(ofertas => {
      const producto = ofertas.find(p => p.id === idProducto);
      if (!producto) return;
      const mensaje = `Hola, quiero comprar este producto:%0A
*${producto.nombre}*%0A
${producto.descripcion || ""}%0A
Precio: ${producto.precio}%0A
Imagen: ${producto.imagen}%0A
${window.location.origin}?producto=${encodeURIComponent(producto.nombre)}`;
      const url = `https://wa.me/573143416441?text=${mensaje}`;
      window.open(url, "_blank");
    });
}

// ============================
// AUTOLOGIN
// ============================
document.addEventListener("DOMContentLoaded", () => {
  const guardado = localStorage.getItem("usuario");
  if (guardado) {
    usuarioActual = JSON.parse(guardado);
    if (mensajeBienvenida) mensajeBienvenida.textContent = `Â¡Bienvenido, ${usuarioActual.nombre}! ðŸ‘‹`;
  }
  cargarProveedores();
  cargarOfertas();
  ocultarPaginacion();
});
